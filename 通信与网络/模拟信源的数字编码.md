模拟信源是**时间连续、幅值连续**的信源，其输出 $s(t)$ 是一个连续时间的[[随机过程的平稳性#^SuijiGuocheng|随机过程]]，将其数字化的过程如下：

![[模拟信源的数字编码.png|模拟信源的数字编码]]

在信道另一侧，接收端对接收到的二值序列进行**译码 (digital decoding)**，恢复出数字信号，然后通过**电平重建 (level reconstruction)** 和**内插 (interpolation)**，即恢复出模拟信号 $\hat{s}(t)$。

## 抽样与内插恢复

**抽样 (sampling)** 是将连续时间信号 $s(t)$ 在时间上离散化的过程，得到离散时间信号 $x[k] = s(kT_{\mathrm{s}})$，其中 $T_{\mathrm{s}}$ 是**抽样周期 (sampling period)**，$f_{\mathrm{s}} = \dfrac{1}{T_{\mathrm{s}}}$ 是**抽样频率 (sampling frequency)**。

> [!theorem] Nyquist 抽样定理
> 设 $s(t)$ 是**带宽受限**的信号，其频谱 $S(f) = \mathcal{F}\left\{ s(t) \right\}$ 满足
> $$
> S(f) = 0, \quad |f| > W
> $$
> 则当抽样频率 $f_{\mathrm{s}} \ge 2W$ 时，可以从抽样所得信号 $x[k] = s(kT_{\mathrm{s}})$ **无失真**地恢复出 $s(t)$。这个最低抽样频率 $f_{\mathrm{s}} = 2W$ 称为 **Nyquist 频率 (Nyquist frequency)**。

从序列 $x[k]$ 恢复出 $s(t)$，可以先以 $x[k]$ 调制冲激序列得到 $\t{s}(t) = \sum\limits_{k} x[k] \delta(t-kT_{\mathrm{s}})$，其 Fourier 变换为
$$
\t{S}(f) = \mathcal{F}\left\{ \t{s}(t) \right\} 
= \sum\limits_{k} x[k] \mathcal{F} \left\{ \delta(t-kT_{\mathrm{s}}) \right\}
= \sum\limits_{k} s(kT_{\mathrm{s}}) \e^{-\J 2 \pi f k T_{\mathrm{s}}}
$$
另一方面，
$$
\begin{align}
\t{S}(f) &= \mathcal{F}\left\{ s(t) \sum\limits_{k} \delta(t-kT_{\mathrm{s}}) \right\} 
= \dfrac{1}{2\pi}S(f) * \mathcal{F}\left\{ \sum\limits_{k} \delta(t-kT_{\mathrm{s}}) \right\} \\
&= \dfrac{1}{T_{\mathrm{s}}} S(f) * \sum\limits_{k} \delta \left( f - k f_{\mathrm{s}} \right) \\
\end{align}
$$
因而需使用增益为 $T_{\mathrm{s}}$ 的**低通滤波器 (low-pass filter, LPF)** 截去 $\t{S}(f)$ 中 $|f| > W$ 的部分，才能恢复出 $S(f)$，输出即为
$$
\hat{S}(f) = \dfrac{1}{f_{\mathrm{s}}} \sum\limits_{k} s(kT_{\mathrm{s}}) \e^{-\J 2 \pi f k T_{\mathrm{s}}} \times \mathbb{1}_{|f| \leq W}
$$
其中 $\mathbb{1}_{P}$ 为事件 $P$ 的指示函数。由此，时域恢复的信源为
$$
\begin{align}
\hat{s}(t) &= \mathcal{F}^{-1}\left\{ \hat{S}(f) \right\} = \dint_{-\infty}^{+\infty} \hat{S}(f) \e^{\J 2 \pi f t} \dif f 
= \dint_{-W}^{W} \dfrac{1}{f_{\mathrm{s}}} \sum\limits_{k} s(kT_{\mathrm{s}}) \e^{-\J 2 \pi f k T_{\mathrm{s}}} \e^{\J 2 \pi f t} \dif f \\
&= \dfrac{1}{f_{\mathrm{s}}} \sum\limits_{k} s(kT_{\mathrm{s}}) \dint_{-W}^{W} \e^{\J 2 \pi f (t - kT_{\mathrm{s}})} \dif f 
= \sum\limits_{k} s(kT_{\mathrm{s}}) \dfrac{\sin (2\pi W(t-kT_{\mathrm{s}}))}{\pi f_{\mathrm{s}} (t-kT_{\mathrm{s}})}
\end{align}
$$
令抽样频率 $f_{\mathrm{s}} = 2W$ 取 Nyquist 频率，则
$$
\hat{s}(t) = \sum\limits_{k} s\left( \dfrac{k}{2W} \right) \sinc \left( 2Wt - k \right)
$$

> [!note] 抽样前的预滤波
> 实际采集到的真实信号一定是全频带的信号，为避免混叠 (aliasing) 干扰，通常先通过**预滤波器 (pre-filter)** 截去高频成分，保留期望频带内的信号，然后再进行抽样。
> 
> 人类的语音信号主要能量集中在 300  $\sim$ 3400 Hz，通常预滤波器的带宽为 3.4 kHz，抽样频率为 8 kHz。

## 量化与电平重建

**量化 (quantization)** 是将幅值连续的信号 $x[k]$ 离散化为数字信号 $\hat{x}[k]$ 的过程。设 $n$-bit 量化器 $Q$ 有 $L=2^{n}$ 个量化级别，则第 $i$ 个量化区间上
$$
Q(x) = y_{i}, \quad x \in (x_{i}, x_{i + 1}], \quad i = 1, 2, \cdots, L
$$
其中，
+ $x_{i}$ 是**分层电平**，$y_{i}$ 是**表示电平**，直接用于重建时即**重建电平**；
+ $I_{i} = (x_{i}, x_{i+1}]$ 称为第 $i$ 个**量化区间 (quantization interval)**，其长度 $\varDelta_{i} = x_{i+1} - x_{i}$ 称为第 $i$ 个**量化间隔 (quantization step)**。

当对每个 $i = 1, 2, \cdots, L$ 有 $\varDelta_{i} \equiv \varDelta$ 时，可有**[[#均匀量化]] (uniform quantization)**，否则只能为**[[#非均匀量化]] (non-uniform quantization)**。

量化器 $Q$ 对输入 $x$ 的**量化误差 (quantization error)** 定义为
$$
e(x) = x - Q(x)
$$
因为 $x$ 可看作**随机变量 $X$**，$e(x)$ 也是随机变量。良好的量化器应使得 $\mathbb{E}\left[ e(X) \right] = 0$，此时其方差为
$$
\begin{align}
\sigma^{2} = \mathbb{E}\left[ e^{2}(X) \right] &= \dint_{-\infty}^{+\infty} (x - Q(x))^{2} p_{X}(x) \dif x \\
&= \sum\limits_{i=1}^{L} \dint_{x_{i}}^{x_{i+1}} (x - y_{i})^{2} p_{X}(x) \dif x
\end{align}
$$

> [!definition] 量化的均方误差
> 对量化器 $Q$，其量化误差的方差 
> $$
> \sigma^{2} = \mathbb{E}\left[ e^{2}(X) \right] = \sum\limits_{i=1}^{L} \dint_{x_{i}}^{x_{i+1}} (x - y_{i})^{2} p_{X}(x) \dif x
> $$
> 称为**量化的均方误差 (mean square error, MSE)**。

若信源 $x$ 超出量化器的表示范围 $[x_{1}, x_{L+1}]$，则会发生**过载失真 (saturation distortion)**，此时量化误差相当于将过载部分全部映射为 $y_{1}$ 或 $y_{L}$，量化误差可拆分为
$$
\sigma^{2} = \sigma^{2}_{\mathrm{q}} + \sigma^{2}_{\mathrm{o}}, \qquad
\begin{cases}
\sigma^{2}_{\mathrm{q}} = \sum\limits_{i=1}^{L} \dint_{x_{i}}^{x_{i+1}} (x - y_{i})^{2} p_{X}(x) \dif x, \\
\sigma^{2}_{\mathrm{o}} = \dint_{-\infty}^{x_{1}} (x - y_{1})^{2} p_{X}(x) \dif x + \dint_{x_{L+1}}^{\infty} (x - y_{L})^{2} p_{X}(x) \dif x
\end{cases}
$$

一般而言，功率较大的信源对量化噪声的容忍程度也比较高，因而我们可以引入量化器 $Q$ 的**信噪比 (signal-to-noise ratio, SNR)**，定义为
$$
\mathrm{SNR}_{\mathrm{q}} = \dfrac{\mathbb{E}\left[ X^{2} \right]}{\mathbb{E}\left[ e^{2}(X) \right]} = \dfrac{\dint_{-\infty}^{\infty} x^{2} p_{X}(x) \dif x}{\sum\limits_{i=1}^{L} \dint_{x_{i}}^{x_{i+1}} (x - y_{i})^{2} p_{X}(x) \dif x}
$$

### 均匀量化

对于均匀量化器，量化间隔 $\varDelta_{i} \equiv \varDelta$，且取**重建电平为区间中点**
$$
y_{i} = \dfrac{x_{i} + x_{i+1}}{2}, \qquad i = 1, 2, \cdots, L
$$
**均匀量化一定限制在有限范围 $[x_\mathrm{min}, x_\mathrm{max}]$ 内**，量化区间长度为 $\varDelta = \cfrac{x_{\mathrm{max}}-x_{\mathrm{min}}}{L}$。我们常令 $x_{\mathrm{min}} = -V$，$x_{\mathrm{max}} = V$，则 $\varDelta = \cfrac{2V}{L}$。

若假设**量化输入 $X$ 均匀分布**于 $[-V, V]$，则 $n$-bit 均匀量化的**量化噪声**为
$$
\sigma^{2} = \dfrac{L}{2V} \dint_{-\varDelta/2}^{\varDelta/2} x^{2} \dif x = \dfrac{\varDelta^{2}}{12} = \dfrac{(2V)^{2}}{12 L^{2}} = \dfrac{V^{2}}{3 \cdot 4^{n}}
$$
因此量化器的**信噪比**为
$$
\mathrm{SNR}_{\mathrm{q}} = \dfrac{\mathbb{E}\left[ X^{2} \right]}{\sigma^{2}} = \cfrac{\dint_{-V}^{V} x^{2} \cdot \dfrac{1}{2V} \dif x}{\dfrac{V^{2}}{3 \cdot 4^{n}}} = \dfrac{V^{2}/3}{V^{2}/(3 \cdot 4^{n})} = 4^{n} \approx 6.02 n \rmu{dB}
$$
即每增加 1 bit 的量化精度，信噪比提高约 6.02 dB。

对一般的量化输入 $X$，当 $\varDelta$ 足够小时，可近似认为均匀量化器**每个量化区间内的 $X$ 服从均匀分布**，此时 $n$-bit 均匀量化的量化噪声近似为
$$
\begin{align} 
\sigma^{2} &= \sum\limits_{i=1}^{L} \dint_{x_{i}}^{x_{i+1}} (x - y_{i})^{2} p_{X}(x) \dif x
\approx \sum\limits_{i=1}^{L} \dint_{x_{i}}^{x_{i+1}} (x - y_{i})^{2} \dif x \dint_{x_{i}}^{x_{i+1}} p_{X}(x) \dif x  \\
&= \dfrac{\varDelta^{2}}{12} \sum\limits_{i=1}^{L} \dint_{x_{i}}^{x_{i+1}} p_{X}(x) \dif x = \dfrac{V^{2}}{3 \cdot 4^{n}} \dint_{-V}^{V} p_{X}(x) \dif x 
\end{align}
$$
噪声功率与信源在量化范围内的分布关联不大，但**信噪比**将依赖于 $\cfrac{\mathbb{E} \left[ X^{2} \right]}{V^{2}}$，信源分布越不均匀，信噪比越低。**均匀量化对均匀分布最优。**

### 非均匀量化

#### 非均匀量化器的设计

非均匀量化器的设计目标是**最小化量化误差的均方值**，即求
$$
\arg\limits_{\{ x_{i} \}, \{ y_{i} \}}\min \sigma^{2} = \arg\limits_{\{ x_{i} \}, \{ y_{i} \}}\min \sum\limits_{i=1}^{L} \dint_{x_{i}}^{x_{i+1}} (x - y_{i})^{2} p_{X}(x) \dif x
$$

+ 对 $x_{i}$ 求偏导，得
$$
\dfrac{\partial \sigma^{2}}{\partial x_{i}} = (x_{i} - y_{i})^{2} p_{X}(x_{i}) - (x_{i} - y_{i-1})^{2} p_{X}(x_{i}) = 0
\quad \Longrightarrow \quad
x_{i} = \dfrac{y_{i} + y_{i-1}}{2}
$$
由此导出**最近邻居准则**：每个分层电平 $x_{i}$ 应取为相邻两个重建电平 $y_{i-1}$ 和 $y_{i}$ 的中点，这**与 $x$ 的分布无关**。

+ 对 $y_{i}$ 求偏导，得
$$
\dfrac{\partial \sigma^{2}}{\partial y_{i}} = -2 \dint_{x_{i}}^{x_{i+1}} (x - y_{i}) p_{X}(x) \dif x = 0
\quad \Longrightarrow \quad
y_{i} = \dfrac{\dint_{x_{i}}^{x_{i+1}} x p_{X}(x) \dif x}{\dint_{x_{i}}^{x_{i+1}} p_{X}(x) \dif x}
$$
由此导出**重心准则**：每个重建电平 $y_{i}$ 应取为对应量化区间内 $x$ 的条件期望，这**与 $x$ 的分布有关**。

> [!algo.] Lloyd-Max 算法 
> Lloyd-Max 算法综合考虑**最近邻居准则**和**重心准则**，通过迭代优化非均匀量化器的分层电平 $\{ x_{i} \}$ 和重建电平 $\{ y_{i} \}$。
> 
> ---
> 
> **GIVEN —** 
> 初始重建电平 $y_1^{(0)} < y_2^{(0)} < \cdots < y_L^{(0)}$
> 
> **REPEAT —**
> 1. 更新分层电平：
> $$
> x_{i}^{(k)} = \dfrac{y_{i}^{(k)} + y_{i+1}^{(k)}}{2}, \quad i = 1, 2, 3, \cdots, L-1
> $$
> 2. 更新重建电平：
> $$
> y_{i}^{(k+1)} = \dfrac{\dint_{x_{i-1}^{(k)}}^{x_{i}^{(k)}} x p_{X}(x) \dif x}{\dint_{x_{i-1}^{(k)}}^{x_{i}^{(k)}} p_{X}(x) \dif x}, \quad i = 1, 2, 3, \cdots, L
> $$
> 
> 　**UNTIL —** 量化噪声 $\sigma_{(k+1)}^{2}$ 小于预设阈值
> 
> **OUTPUT —**
> 最终分层电平 $\{ x_{i}^{*} \}$ 和重建电平 $\{ y_{i}^{*} \}$

#### 压扩量化

对于幅值分布高度集中的信源，如语音信号，其幅值通常服从 **Laplace 分布**或 **Gauss 分布**，均匀量化器难以取得较好的量化效果。注意到**非线性映射**可以改变随机变量的分布形状，因此可以先对信源进行**压扩 (companding)** 处理，再进行均匀量化，从而达到非均匀量化的效果。

常用的压扩函数有：
+ **$\mu$ 律压扩**函数 $g(x) = x_{\mathrm{max}} \sgn(x) \dfrac{\log\left( 1 + \mu \cfrac{|x|}{x_{\mathrm{max}}} \right)}{\log(1 + \mu)}$，其中 $\mu > 0$ 是压扩参数；
+ **A 律压扩**函数 $g(x) = \begin{cases} A \sgn(x) \dfrac{|x|}{1 + \ln A}, & 0 \leq |x| \leq \dfrac{x_{\mathrm{max}}}{A}, \\ x_{\mathrm{max}} \sgn(x) \dfrac{1 + \ln \left( A \cfrac{|x|}{x_{\mathrm{max}}} \right)}{1 + \ln A}, & \dfrac{x_{\mathrm{max}}}{A} < |x| \leq x_{\mathrm{max}} \end{cases}$，其中 $A > 1$ 是压扩参数。

#### 高分辨率量化

当量化级数 $L$ 很大时，量化间隔 $\varDelta_{i}$ 很小，可以近似认为在量化区间 $I_{i} = (x_{i}, x_{i+1}]$ 上，**信源概率密度函数 $p_{X}(x)$ 近似为常数 $p_{X}(x_{i}^{*})$**，其中 $x_{i}^{*} \in I_{i}$。此时，量化噪声可近似为
$$
\sigma^{2} \approx \sum\limits_{i=1}^{L} p_{X}(x_{i}^{*}) \dint_{x_{i}}^{x_{i+1}} (x - y_{i})^{2} \dif x = \sum\limits_{i=1}^{L} p_{X}(x_{i}^{*}) \dfrac{\varDelta_{i}^{3}}{12}
$$
由 Lagrange 中值定理，可取 $p_{X}(x_{i}^{*}) = \cfrac{1}{\varDelta_{i}} \dint_{x_{i}}^{x_{i+1}} p_{X}(x) \dif x = \cfrac{P_{i}}{\varDelta_{i}}$，从而
$$
\sigma^{2} \approx \dfrac{1}{12} \sum\limits_{i=1}^{L} P_{i} \varDelta_{i}^{2} \stackrel{\varDelta_{i} \equiv \varDelta}{=\!=\!=} \dfrac{\varDelta^{2}}{12}
$$
对其做无损压缩，**最小码长**为
$$
\begin{align} 
H(Q(X)) &= - \sum\limits_{i=1}^{L} \left( p_{X}(x_{i}^{*}) \varDelta \right) \log \left( p_{X}(x_{i}^{*}) \varDelta \right) \\
&= - \sum\limits_{i=1}^{L} p_{X}(x_{i}^{*}) \varDelta \log p_{X}(x_{i}^{*}) - \sum\limits_{i=1}^{L} p_{X}(x_{i}^{*}) \varDelta \log \varDelta  \\
&= - \dint_{-\infty}^{+\infty} p_{X}(x) \log p_{X}(x) \dif x - \log \varDelta  \\
&= h(X) - \log \varDelta \approx h(X) - \log \sigma - 1.8
\end{align}
$$
其中 $h(X) = - \dint_{-\infty}^{+\infty} p_{X}(x) \log p_{X}(x) \dif x$ 是信源 $X$ 的**[[信源#连续信源的微分熵|微分熵]]**。


