关系代数是一种抽象的查询语言，用**对关系的运算**来表达查询，作为研究关系数据语言的数学工具。

## 关系代数操作

### 基本操作

#### 并 (union)

两个关系 $\mathscr{R}$ 和 $\mathscr{S}$ 的**并**要求 $\mathscr{R}$ 和 $\mathscr{S}$ **相容 (compatible)**，即它们必须具有相同的度，且对应位置的属性必须来自同一域。从实际意义出发，两个关系相容意味着它们具有相同的属性集 $U$。

> [!definition] 关系的并
> 给定**相容**的两个关系  $\mathscr{R}(U)$ 和 $\mathscr{S}(U)$，其**并 $\mathscr{R} \cup \mathscr{S}$** 定义为包含所有属于 $\mathscr{R}$ 或 $\mathscr{S}$ 的元组的关系，即
> $$
> \mathscr{R} \cup \mathscr{S} = \{t \mid t \in \mathscr{R} \lor t \in \mathscr{S}\}
> $$

并操作的结果中没有重复的元组。

#### 差 (minus)

> [!definition] 关系的差
> 给定**相容**的两个关系  $\mathscr{R}(U)$ 和 $\mathscr{S}(U)$，其**差 $\mathscr{R} - \mathscr{S}$** 定义为包含所有属于 $\mathscr{R}$ 但不属于 $\mathscr{S}$ 的元组的关系，即
> $$
> \mathscr{R} - \mathscr{S} = \{t \mid t \in \mathscr{R} \land t \notin \mathscr{S}\}
> $$

#### Cartesian 积 (cartesian product)

> [!definition] 关系的 Cartesian 积
> 给定两个关系 $\mathscr{R}(U)$ 和 $\mathscr{S}(V)$，其 **Cartesian 积 $\mathscr{R} \times \mathscr{S}$** 定义为包含所有元组对 $(t_{\mathrm{r}}, t_{\mathrm{s}})$ 的关系，其中 $t_{\mathrm{r}} \in \mathscr{R}$，$t_{\mathrm{s}} \in \mathscr{S}$，即
> $$
> \mathscr{R} \times \mathscr{S} = \{t \mid t = t_{\mathrm{r}} \cup t_{\mathrm{s}} \land t_{\mathrm{r}} \in \mathscr{R} \land t_{\mathrm{s}} \in \mathscr{S}\}
> $$

两个关系的 Cartesian 积是两个关系的**元组对**的集合所组成的新关系，其度是两个关系度之和，基数是两个关系基数之积。

#### 投影 (project)

> [!definition] 关系的投影
> 给定关系 $\mathscr{R}(U)$ 和属性集 $X \subseteq U$，其**投影 $\Pi_{X}(\mathscr{R})$** 定义为包含所有属于 $\mathscr{R}$ 的元组在属性集 $X$ 上的投影的关系，即
> $$
> \Pi_{X}(\mathscr{R}) = \{t[X] \mid t \in \mathscr{R}\}
> $$

投影运算从列的角度对关系（表）进行纵向截切和重组，形成新表。

#### 选择 (select)

> [!definition] 关系的选择
> 给定关系 $\mathscr{R}(U)$ 和条件 $C$，其**选择 $\sigma_{C}(\mathscr{R})$** 定义为包含所有属于 $\mathscr{R}$ 且满足条件 $C$ 的元组的关系，即
> $$
> \sigma_{C}(\mathscr{R}) = \{t \mid t \in \mathscr{R} \land C(t)\}
> $$
> 其中，条件 $C$ 是关于 $t$ 的属性集 $U$ 的谓词，由**比较运算符**（$=$、$<$、$>$、$\leq$、$\geq$、$\neq$）和**逻辑运算符**（$\land$、$\lor$、$\neg$）连接而成。

选择运算从行的角度对关系（表）进行横向截切，形成新表。

### 组合操作

#### 交 (intersection)

> [!definition] 关系的交
> 给定**相容**的两个关系  $\mathscr{R}(U)$ 和 $\mathscr{S}(U)$，其**交 $\mathscr{R} \cap \mathscr{S}$** 定义为包含所有属于 $\mathscr{R}$ 且也属于 $\mathscr{S}$ 的元组的关系，即
> $$
> \mathscr{R} \cap \mathscr{S} = \{t \mid t \in \mathscr{R} \land t \in \mathscr{S}\}
> $$

交操作可以由**差**导出：
$$
\mathscr{R} \cap \mathscr{S} = \mathscr{R} - (\mathscr{R} - \mathscr{S})
$$

#### 连接 (join)

> [!definition] 关系的自然连接
> 给定两个关系 $\mathscr{R}(U)$ 和 $\mathscr{S}(V)$，其**自然连接 $\mathscr{R} \bowtie \mathscr{S}$** 定义为二者在它们的公共属性 $B = U \cap V$ 上相等的元组去掉公共属性 $B$ 后形成的元组集合，即
> $$
> \mathscr{R} \join \mathscr{S} = 
> \left\{ \overline{t_{\mathrm{r}}t_{\mathrm{s}}} [(U-B) \cap (V-B)] \,\Big|\, 
> t_{\mathrm{r}} \in \mathscr{R} \land t_{\mathrm{s}} \in \mathscr{S} \land t_{\mathrm{r}}[B] = t_{\mathrm{s}}[B] \right\}
> $$

自然连接是关系数据库中最重要的操作之一，通常用于**关联查询 (join query)**。更一般地，将关联查询的条件推广为任意条件 $C$，则有**条件连接 (conditional join)**。

> [!definition] 关系的条件连接
> 给定两个关系 $\mathscr{R}(U)$ 和 $\mathscr{S}(V)$ 及条件 $C$，其**条件连接 $\mathscr{R} \join_{C} \mathscr{S}$** 定义为二者中满足条件 $C$ 的元组形成的集合，即
> $$
> \mathscr{R} \join_{C} \mathscr{S} =
> \left\{ \overline{t_{\mathrm{r}}t_{\mathrm{s}}} \,\Big|\, 
> t_{\mathrm{r}} \in \mathscr{R} \land t_{\mathrm{s}} \in \mathscr{S} \land C(t_{\mathrm{r}}, t_{\mathrm{s}}) \right\}
> $$
> 其中，条件 $C$ 是关于 $t_{\mathrm{r}}$ 和 $t_{\mathrm{s}}$ 的属性集 $U$ 和 $V$ 的谓词，由**比较运算符**（$=$、$<$、$>$、$\leq$、$\geq$、$\neq$）和**逻辑运算符**（$\land$、$\lor$、$\neg$）连接而成。
> 
> 当 $C$ 仅包含 $\mathscr{R}$ 的一个属性 $A$ 与 $\mathscr{S}$ 的一个属性 $B$ 之间的比较时，称为 **$\theta$ 连接 ($\theta$-join)**，记作 $\mathscr{R} \join_{A\theta B} \mathscr{S}$， 其中 $\theta$ 是任一比较运算符；特别地，当 $\theta$ 是等号时，$\theta$ 连接称为**等值连接 (equi-join)**。 

注意，自然连接中相等的分量必须是**相同的属性组**，并且要在结果中去掉重复的属性，而等值连接则不必。

两个关系的自然连接会**舍弃**那些在公共属性上**没有匹配**的元组，这种连接方式称为**内连接 (inner join)**。如果要保留这些元组，可以使用**外连接 (outer join)**，将未匹配的元组补齐空值后纳入结果，其中这些未匹配的元组称为**悬浮元组 (dangling tuple)**。只保留左关系 $\mathscr{R}$ 中悬浮元组的连接称为**左外连接 (left outer join)**，记作 $\mathscr{R} \lojoin \mathscr{S}$；只保留右关系 $\mathscr{S}$ 中悬浮元组的连接称为**右外连接 (right outer join)**， 记作 $\mathscr{R} \rojoin \mathscr{S}$；保留两边悬浮元组的连接称为**全外连接 (full outer join)**，记作 $\mathscr{R} \fojoin \mathscr{S}$。

#### 除 (division)

对于关系 $\mathscr{R}(U)$，设 $x$ 是属性组 $X \subset U$ 的一个取值，余下属性组为 $Y = U - X$，称 $x$ 在 $\mathscr{R}$ 中有**象集 (image set)** 为
$$
\{ t[Y] \mid t \in \mathscr{R} \land t[X] = x \}
$$
即在 $X$ 上取值为 $x$ 的元组的余下分量之集合，此处简记为 $\mathscr{Y}_{\mathscr{R}|x}$。求象集的过程可视为对关系进行**选择**和**投影**两步操作，即写为
$$
\mathscr{Y}_{\mathscr{R}|x} = \Pi_{Y}(\sigma_{X=x}(\mathscr{R}))
$$

> [!definition] 关系的除
> 给定两个关系 $\mathscr{R}(U)$ 和 $\mathscr{S}(V)$，属性集 $X = U - V$，$Y = U \cap V$。两个关系的**除 $\mathscr{R} \div \mathscr{S}$** 定义为
> $$
> \mathscr{R} \div \mathscr{S} = 
> \left\{ t_{\mathrm{r}} [X] \mid t_{\mathrm{r}} \in \mathscr{R} \land \Pi_{Y}(\mathscr{S}) \subseteq \mathscr{Y}_{\mathscr{R}|t_{\mathrm{r}} [X]} \right\}
> $$

除操作同时从关系的行和列角度进行运算，其结果是一个新关系，包含那些在被除关系 $\mathscr{R}$ 中的元组 $t_{\mathrm{r}}$ 的 $X$ 分量，使得 **$\mathscr{S}$ 在公共属性集 $Y$ 上的投影包含在 $t_{\mathrm{r}}[X]$ 对 $\mathscr{R}$ 的象集中**。除操作的计算可表达为：
1. 对 $\mathscr{R}$ 在 $X$ 上投影，得到 $\mathscr{T} = \Pi_{X}(\mathscr{R})$；
2. 求 $\mathscr{T}$ 与 $\mathscr{S}$ 的 Cartesian 积，并从中减去 $\mathscr{R}$，得到 $\mathscr{W} = (\mathscr{T} \times \mathscr{S}) - \mathscr{R}$；
3. 对 $\mathscr{W}$ 在 $X$ 上投影，得到 $\Pi_{X}(\mathscr{W})$；
4. 用 $\mathscr{T}$ 减去 $\Pi_{X}(\mathscr{W})$，即得到 $\mathscr{R} \div \mathscr{S} = \mathscr{T} - \Pi_{X}(\mathscr{W})$。

> [!example]- 除运算的示例
> 已知一个**学生选课关系 SC**：
> ```tx
> | **SC** | 姓名 `SN` | 课程 `CN` | 学期 `SS` |
> | :-- | :-- | :-- | :-- |
> |     | 张三    | 高等微积分  | 2023-2024-1 |
> |     | 张三    | 计算机程序设计基础  | 2024-2025-1 |
> |     | 李四    | 高等微积分  | 2023-2024-1 |
> |     | 李四    | 线性代数    | 2023-2024-2 |
> ```
> 和一个待查的**数学系课程关系 CM**：
> ```tx
> | **CM** | 课程号 `CNO` | 课程名 `CN` | 学分 `CP` |
> | :-- | :-- | :-- | :-- |
> |     | 00000001 | 高等微积分  | 5    |
> | 	  | 00000002 | 线性代数    | 4    |
> ```
> 要查询**选修了所有数学系课程（CM 中所有课程）的学生**，可用除运算表示为 $\Pi_{\texttt{SN},\texttt{CN}}\text{SC} \div \text{CM}$，结果为一个新关系 SCM：
> ```tx
> | **SCM** | 姓名 `SN` |
> | :-- | :-- |
> |     | 李四    |
> ```
> ---
> 运算过程如下：
> 1. $\Pi_{\texttt{SN},\texttt{CN}}\text{SC}$ 和 CM 的公共属性集为 $Y = \{\texttt{CN}\}$，$\Pi_{\texttt{SN},\texttt{CN}}\text{SC}$ 中剩余属性集为 $X = \{\texttt{SN}\}$，对 $\Pi_{\texttt{SN},\texttt{CN}}\text{SC}$ 在 $X$ 上投影，得到 $\mathscr{T}$：$\mathscr{S}$：
> 	```tx
> 	| **$\mathscr{T} = \Pi_{\texttt{SN}}\Pi_{\texttt{SN},\texttt{CN}} \text{SC}$** | 姓名 `SN` |
> 	| :-- | :-- |
> 	|     | 张三    |
> 	|     | 李四    |
> 	```
> 2. 求学生信息与 CM 中课程信息的全部组合 $\mathscr{T} \times \text{CM}$，并从中减去在 $\Pi_{\texttt{SN},\texttt{CN}}\text{SC}$ 中存在的元组，得到 $\mathscr{W}$：
> 	```tx
> 	| **$\mathscr{W} = (\mathscr{T} \times \text{CM}) - \Pi_{\texttt{SN},\texttt{CN}}\text{SC}$** | 姓名 `SN` | 课程号 `CNO` | 课程名 `CN` | 学分 `CP` |
> 	| :-- | :-- | :-- | :-- | :-- | :-- |
> 	|     | 张三    | 00000002 | 线性代数    | 4    |
> 	```
> 3. 对 $\mathscr{W}$ 在 $X$ 上投影，即为没有选修所有数学系课程的学生集合 $\Pi_{\texttt{SN}}\mathscr{W}$：
> 	```tx
> 	| **$\Pi_{\texttt{SN}}\mathscr{W}$** | 姓名 `SN` |
> 	| :-- | :-- |
> 	|     | 张三    |
> 	```
> 4. 最后用 $\mathscr{T}$ 减去 $\Pi_{\texttt{SN}}\mathscr{W}$，即得到选修了所有数学系课程的学生集合 SCM：
> 	```tx
> 	| **SCM = $\mathscr{T} - \Pi_{\texttt{SN}}\mathscr{W}$** | 姓名 `SN` |
> 	| :-- | :-- |
> 	|     | 李四    |
> 	```

## 关系代数应用

用关系代数表达式写查询语句，一般遵循以下步骤：
1. 确定查询涉及的关系；
2. 执行 Cartesian 积或连接，形成一个大的中间关系；
3. 根据查询需求，对中间关系执行水平分割（**选择**操作）或垂直分割（**投影**操作）。

