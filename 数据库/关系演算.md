## 域关系演算语言 QBE

**QBE (Query By Example)** 是 IBM 公司于 1970 年代初开发的一种关系查询语言，属于**域关系演算 (domain relational calculus)** 的一种实现形式。其基本思想是通过**表格形式**给出一个查询**例子 (example)** 来描述所要查询的数据。

表格的查询形式是 QBE 的突出特点，用户通过终端屏幕编辑程序，以填写表格的方式构造查询要求，而查询结果也是以表格形式显示，因此非常直观、易学易用。

QBE 的基本**操作框架**如：

| **关系名** | 属性名 1 | 属性名 2 | $\cdots$ | 属性名 $n$ |
| :------ | :---- | :---- | :------- | :------ |
|         |       |       | $\cdots$ |         |
其中，用户通过在表格左上角填写**关系名**限定查询对象，QBE 系统将自动在第一行填充**属性名**，用户在其下方填写查询条件，空白处表示对该属性不加限制。

### QBE 检索操作

#### 简单条件查询

QBE 检索时，用户在属性名下方填写查询条件，表示对该属性的限制。

> [!example] QBE 检索操作示例：简单查询
> 在**学生信息表 S** 中，求电子系 (`sDept` $=$ EE) 全体学生的姓名 `sName`。
> 
> | **S** | 学号 `sNo` | 姓名 `sName` | 性别 `sSex` | 系别 `sDept` | 年龄 `sAge` |
> | :-- | :-- | :-- | :-- | :-- | :-- |
> |     |     | **P.** $\underline{\textit{T}}$ |     | EE    |    |

上例中：
+ 用户在 `sDept` 下方填写「EE」，表示**查询条件**为查询电子系的学生。
	+ 查询条件中可以使用**关系运算符**（$=$、$>$、$<$、$\geq$、$\leq$、$\neq$），其中 $=$ 可以省略不写，此处即为一例。
+ 在 `sName` 下方填写 **P.** $\underline{\textit{T}}$，表示**查询对象**为查询学生姓名。
	+ **P.** 为**打印 (print) 操作符**，表示将该属性值显示在查询结果中；
	+ $\underline{\textit{T}}$ 是**示例元素**，即**域变量 (domain variable)**，需要加下划线，表示该属性值可以是任意值。

> [!example] QBE 检索操作示例：与 (AND) 条件查询
> 求电子系 (`sDept` $=$ EE) 年龄大于 20 岁 (`sAge` $>$ 20) 的学生姓名 `sName` 和年龄 `sAge`。
> 
> | **S** | 学号 `sNo` | 姓名 `sName` | 性别 `sSex` | 系别 `sDept` | 年龄 `sAge` |
> | :-- | :-- | :-- | :-- | :-- | :-- |
> | 	 |     | **P.** $\underline{\textit{T}}$ |     | EE    | **P.** $>$ 20 |

写在同一行上的条件表示**与 (AND)** 关系；此外，也可以用不同行上同一属性下的**同一个示例名**表示**与**的关系，如：

| **S** | 学号 `sNo` | 姓名 `sName`                      | 性别 `sSex` | 系别 `sDept` | 年龄 `sAge`     |
| :---- | :------- | :------------------------------ | :-------- | :--------- | :------------ |
|       |          | **P.** $\underline{\textit{T}}$ |           |            | **P.** $>$ 20 |
|       |          | $\underline{\textit{T}}$        |           | EE         |               |

> [!example] QBE 检索操作示例：或 (OR) 条件查询
> 求电子系 (`sDept` $=$ EE) 的学生或全校年龄大于 20 岁 (`sAge` $>$ 20) 的学生的姓名 `sName`。
> 
> | **S** | 学号 `sNo` | 姓名 `sName`                       | 性别 `sSex` | 系别 `sDept` | 年龄 `sAge`     |
> | :---- | :------- | :------------------------------- | :-------- | :--------- | :------------ |
> |       |          | **P.** $\underline{\textit{S1}}$ |           |            | **P.** $>$ 20 |
> |       |          | **P.** $\underline{\textit{S2}}$ |           | EE         | **P.**        |

不同行上同一属性下**不同的示例名**表示**或 (OR)** 的关系。

> [!example] QBE 检索操作示例：非 (NOT) 条件查询
> 在**选课关系表 SC** 中，求没有选择《数据库》课程 (`cNo` $=$ cNoDatabase) 的学生的学号 `sNo`。
> 
> | **SC** | 学号 `sNo`                    | 课程号 `cNo`   | 成绩 `grade` |
> | :----- | :-------------------------- | :---------- | :--------- |
> | $\lnot$      | **P.** $\underline{\textit{T}}$ | cNoDatabase |            |

^540736

要表示**非 (NOT)** 的关系，可以在**关系名**一列加上**否定符号 ($\lnot$)**，这表示查找**不满足该行条件**的元组。若将「$\lnot$」加在示例元素前面，则表示**该属性值不等于**该示例元素的值。

> [!example] QBE 检索操作示例：使用「示例元素的非」查询
> 查询至少 2 人选修的课程号 `cNo`。
> 
> | **SC** | 学号 `sNo`                    | 课程号 `cNo`               | 成绩 `grade` |
> | :----- | :-------------------------- | :----------------------- | :--------- |
> |        | $\underline{\textit{S}}$ | **P.** $\underline{\textit{C}}$ |            |
> |        | $\lnot\underline{\textit{S}}$ | $\underline{\textit{C}}$ |            |

#### 多表联合查询

可以通过不同关系中相同属性的**相同示例元素**在多张表中建立联系，从而实现**联合查询 (join query)**。

> [!example] QBE 检索操作示例：多表联合查询
> **联合查找 S 与 SC**，查询电子系 (`sDept` $=$ EE) 没有选修《数据库》课程 (`cNo` $=$ cNoDatabase) 的学生姓名 `sName`。
> 
> | **S** | 学号 `sNo`                    | 姓名 `sName`                      | 性别 `sSex` | 系别 `sDept` | 年龄 `sAge` |
> | :---- | :-------------------------- | :------------------------------ | :-------- | :--------- | :-------- |
> |       | $\underline{\textit{0000}}$ | **P.** $\underline{\textit{S}}$ |           |  EE          |           |
> 
> | **SC** | 学号 `sNo`                    | 课程号 `cNo`   | 成绩 `grade` |
> | :----- | :-------------------------- | :---------- | :--------- |
> | $\lnot$      | $\underline{\textit{0000}}$ | cNoDatabase |            |
> | $\lnot$      | $\underline{\textit{0000}}$ |    |            |

上例与[[#^540736|非条件查询示例]]的区别是，S 表中学生信息是全面的，而 SC 表中只包含选课学生的信息，因此有 SC 表查询的第二行，表示选择出没有选任何课、不在 SC 表中的学号 $\underline{\textit{0000}}$。

#### 聚集函数查询

QBE 支持一些使用**聚集函数 (aggregate function)** 的查询操作。常用的聚集函数有：
+ **CNT**，表示计数 (count)；
+ **SUM**，表示求和 (sum)；
+ **AVG**，表示平均值 (average)；
+ **MAX**，表示最大值 (maximum)；
+ **MIN**，表示最小值 (minimum)。

> [!example] QBE 检索操作示例：使用聚集函数查询
> 查询电子系 (`sDept` $=$ EE) 学生的平均年龄。
> 
> | **S** | 学号 `sNo` | 姓名 `sName` | 性别 `sSex` | 系别 `sDept` | 年龄 `sAge`    |
> | :---- | :------- | :--------- | :-------- | :--------- | :----------- |
> |       |          |            |           | EE         | **P.** $\underline{\textbf{AVG}}$ |

#### 查询结果排序

QBE 支持使用**排序符号**对查询结果进行排序，**AO($i$).** 表示升序排列，**DO($i$).** 表示降序排列，其中 $i$ 为排序的优先级，$i$ 值越小优先级越高。

> [!example] QBE 检索操作示例：排序查询
> 查询电子系 (`sDept` $=$ EE) 全体学生的姓名 `sName` 和年龄 `sAge`，并按年龄降序排列，相同年龄者按姓名升序排列。
> 
> | **S** | 学号 `sNo` | 姓名 `sName`            | 性别 `sSex` | 系别 `sDept` | 年龄 `sAge`          |
> | :---- | :------- | :------------------ | :-------- | :--------- | :----------------- |
> |       |          | **P.**  AO(2). $\underline{\textit{T}}$ |           | EE         | **P.** DO(1). $\underline{\textit{22}}$ |

