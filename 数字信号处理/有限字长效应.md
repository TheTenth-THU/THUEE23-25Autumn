## 二进制表示的量化误差

### 浮点数

在计算机中，浮点数通常采用科学计数法表示，即一个数可以表示为
$$
x = 2^{c} \times M
$$
其中 $c$ 称为**阶码 (exponent)**，$M$ 称为**尾数 (mantissa)**。在二进制浮点数表示中，尾数 $M$ 通常表示为
$$
M = \overline{ 1.b_1 b_2 b_3 \cdots b_{t} } = 1 + \sum\limits_{i=1}^{t} b_i 2^{-i}
$$
其中 $b_i \in \{0, 1\}$，$t$ 为尾数的有效位数（不包括隐含的最高位 $1$）。例如，IEEE 754 单精度浮点数采用 $23$ 位尾数和 $8$ 位阶码表示。

浮点数表示的**动态范围较大**，**量化误差较小**。

### 定点数

定点数表示相当于只考虑浮点数的尾数部分，即对 $x \in [-1,1)$ 进行量化表示。在 **2-补码**表示中，定点数 $x$ 可表示为
$$
[x] = \begin{cases}
|x|, & 0 \le x < 1,  \\
2 - |x|, & -1 \le x < 0
\end{cases} = \overline{ b_0.b_1 b_2 b_3 \cdots b_{t} } 
$$
其中 $b_i \in \{0, 1\}$，$t$ 为定点数的小数位数，符号位 $b_{0} = \begin{cases} 0, & x > 0, \\ 1, & x < 0 \end{cases}$。

考虑表示位数无限，则定点数 $x$ 可**精确表示**为
$$
x = -b_0 + \sum\limits_{i=1}^{\infty} b_i 2^{-i}
$$

#### 截尾 (floor) 误差

对于有限字长 $(B + 1)$ bit 的定点数表示，**截尾法**得到的量化值为
$$
\hat{x}_{\mathrm{T}} = -b_0 + \sum\limits_{i=1}^{B} b_i 2^{-i}
$$
其**量化误差**为
$$
e_{\mathrm{T}} = \hat{x}_{\mathrm{T}} - x = - \sum\limits_{i=B+1}^{\infty} b_i 2^{-i}
$$
显然，该误差的最大值为 $0$，最小值为 $-2^{-B}$。考虑输入的随机性，截尾误差可建模为**均匀分布**在 $\left[-2^{-B}, 0 \right]$ 上的随机变量。

#### 舍入 (round) 误差

对于有限字长 $(B + 1)$ bit 的定点数表示，**舍入法**得到的量化值为
$$
\hat{x}_{\mathrm{R}} = -b_0 + \sum\limits_{i=1}^{B} b_i 2^{-i} + b_{B+1} \cdot 2^{-B}
$$
注意，二进制下的舍入为截断的第 1 位 $b_{B+1}$ 为 1 即进 1，否则舍去。其**量化误差**为
$$
e_{\mathrm{R}} = \hat{x}_{\mathrm{R}} - x = - \sum\limits_{i=B+1}^{\infty} b_i 2^{-i} + b_{B+1} \cdot 2^{-B}
$$
显然，该误差的最大值为 $2^{-(B+1)}$，最小值为 $-2^{-(B+1)}$。考虑输入的随机性，舍入误差可建模为**均匀分布**在 $\left[-2^{-(B+1)}, 2^{-(B+1)} \right]$ 上的随机变量。

> [!note] 量化误差的统计特性


## 量化误差的统计分析

### 系统直接实现方式的误差分析

系统的量化误差可通过**误差传递分析**进行分析。考虑系统的直接实现，量化误差有两类来源：
+ **采样量化误差**：输入信号 $x(t)$ 经过采样和量化后得到离散信号 $x[n]$ 引入的量化误差。
+ **计算量化误差**：系统在处理离散信号 $x[n]$ 的过程中，由于有限字长引入的量化误差。

#### 采样量化误差及其传播

设采样位数为 $1 + B$，采样量化误差 $e[n]$ 的**统计特性**为：
+ 均值 $\mathbb{E} \left[ e[n] \right] = 0$；
+ **功率 $\sigma_{\mathrm{Q}}^{2} = \cfrac{1}{12}(2^{-B})^{2} = \cfrac{1}{12} \times 2^{-2B}$**，功率谱密度为 $S_{\mathrm{Q}}( \omega ) = \sigma_{\mathrm{Q}}^{2}$。

设系统的冲激响应为 $h[n]$，则采样量化误差**通过系统后的输出误差**为
$$
f_{\mathrm{Q}}[n] = e[n] * h[n] = \sum\limits_{m=-\infty}^{\infty} e[m] \cdot h[n - m]
$$
其有统计特性：
+ 均值 $\mathbb{E} \left[ f_{\mathrm{Q}}[n] \right] = 0$；
+ 功率由 Parseval 定理得 $\sigma_{\mathrm{Q, out}}^{2} = \sigma_{\mathrm{Q}}^{2} \cdot \sum\limits_{n=-\infty}^{\infty} \left| h[n] \right|^{2}$；
+ 功率谱密度由 Wiener-Khinchin 定理得 $S_{\mathrm{Q, out}}(\omega) = \sigma_{\mathrm{Q}}^{2} \cdot \left| H(\e^{\J \omega}) \right|^{2}$。

#### 计算量化误差及其传播

## 计算溢出及其避免

在有限字长系统中，**计算溢出 (overflow)** 是指在算术运算过程中，结果超出了所能表示的数值范围，导致结果错误或不可预测的现象。

我们主要考虑 **$[-1, 1]$ 范围的定点数**表示下**加法**溢出的问题。考虑一个反馈系统
$$
w[n] = x[n] + a \cdot w[n-1]
$$
其系统函数为
$$
L(z) = \dfrac{W(z)}{X(z)} = \dfrac{1}{1 - a z^{-1}}
$$
当 $|a| < 1$ 时，系统**稳定**，且其单位样值响应为 $l[n] = a^{n} u[n]$。尽管系统稳定，但在有限字长实现时，仍可能发生溢出；要避免 $w[n]$ 的溢出，需满足
$$
|w[n]| = \left| \sum\limits_{m=0}^{\infty} l[m] x[n-m] \right| \le \max |x[n]| \cdot \sum\limits_{m=0}^{\infty} |l[m]| \le 1
$$

### 压缩比例因子

为避免 $w[n]$ 溢出，需
$$
\max |x[n]| \le \dfrac{1}{\sum\limits_{m=0}^{\infty} |l[m]|} = \dfrac{1}{\left\lVert l[n] \right\rVert _{1}}
$$
引入**压缩比例因子 (scaling factor)** $\beta$，将输入信号 $x[n]$ 压缩 $\beta$ 倍为 $\cfrac{x[n]}{\beta}$，即可恒成立上述不等式，从而避免溢出。

#### 第 I 类压缩比例因子

若 $x[n]$ 是**窄带信号** $x[n] = \cos(\omega_{0}n + \varphi)$，有 $\max |x[n]| = 1$，输出为
$$
|w[n]| = \left| L(\e^{\J \omega_{0}}) \cos (\omega_{0}n + \varphi + \arg L(\e^{\J \omega_{0}})) \right| \le \left| L(\e^{\J \omega_{0}}) \right| \le 1
$$
因此取压缩比例因子
$$
\beta_{\mathrm{I}} = \max_{-\pi \le \omega \le \pi} \left| L(\e^{\J \omega}) \right| = \left\lVert L(\e^{\J \omega}) \right\rVert_{\infty}
$$

#### 第 II 类压缩比例因子

若 $x[n]$ 是**能量受限信号**，有 $\sum\limits_{n=0}^{\infty} |x[n]|^{2} \le 1$，则有
$$
\begin{align}
|w[n]| & = \left| \dfrac{1}{2\pi} \int_{-\pi}^{\pi} L(\e^{\J \omega}) X(\e^{\J \omega}) \e^{\J \omega n} \dif \omega \right| \le \dfrac{1}{2\pi} \int_{-\pi}^{\pi} \left| L(\e^{\J \omega}) \right| \cdot \left| X(\e^{\J \omega}) \right| \dif \omega \\
&\le \sqrt{ \dfrac{1}{2\pi} \int_{-\pi}^{\pi} \left| L(\e^{\J \omega}) \right|^{2} \dif \omega } \cdot \sqrt{ \dfrac{1}{2\pi} \int_{-\pi}^{\pi} \left| X(\e^{\J \omega}) \right|^{2} \dif \omega } \\
&\le \sqrt{ \dfrac{1}{2\pi} \int_{-\pi}^{\pi} \left| L(\e^{\J \omega}) \right|^{2} \dif \omega } = \sqrt{ \sum\limits_{n=-\infty}^{\infty} |l[n]|^{2} } = \left\lVert l[n] \right\rVert_{2} \le 1
\end{align}
$$
因此，考虑到输入信号一般不为能量有限信号，取压缩比例因子
$$
\beta_{\mathrm{II}} = C \cdot \left\lVert l[n] \right\rVert_{2}, \qquad C > 1
$$

### 压缩因子的加入


## 系数量化误差

在有限字长系统中，系统系数的量化误差会**影响零极点的位置**，其中**极点位置的变化会显著影响系统的稳定性**。考虑系统函数
$$
H(z) = \dfrac{\sum\limits_{r=0}^{M} b_{r} z^{-r}}{1 + \sum\limits_{k=1}^{N} a_{k} z^{-k}} = \dfrac{B(z)}{A(z)}
$$
对每个系数，均需**引入量化误差**，即
$$
\hat{H}(z) = \dfrac{\sum\limits_{r=0}^{M} \hat{b}_{r} z^{-r}}{1 + \sum\limits_{k=1}^{N} \hat{a}_{k} z^{-k}}, \qquad \begin{cases}
\hat{a}_{k} = Q \left\{ a_{k} \right\} = a_{k} + \Delta a_{k}, \\
\hat{b}_{r} = Q \left\{ b_{r} \right\} = b_{r} + \Delta b_{r}
\end{cases}
$$
其中 $Q\{\cdot\}$ 表示量化操作，$\Delta a_{k}, \Delta b_{r}$ 分别为系数 $a_{k}, b_{r}$ 的量化误差。

我们考虑某一个 $\Delta a_{k}$ 对系统极点位置的影响。设系统的极点为 $\left\{ p_{j} \right\}$，其全微分为
$$
\Delta p_{j} = \sum\limits_{k=1}^{N} \dfrac{\partial p_{j}}{\partial a_{k}} \Delta a_{k} = \sum\limits_{k=1}^{N} \dfrac{\cfrac{\partial A(z)}{\partial a_{k}} \Bigg|_{z=p_{j}}}{\cfrac{\partial A(z)}{\partial p_{j}} \Bigg|_{z=p_{j}}} \Delta a_{k} 
$$
假设**只有一阶极点**，则
$$
A(z) = 1 + \sum\limits_{k=1}^{N} a_{k} z^{-k} = \prod\limits_{k=1}^{N} (1 - p_{k} z^{-1})
$$
因此有
$$
\begin{align}
\dfrac{\partial A(z)}{\partial a_{k}} \Bigg|_{z=p_{j}} & = p_{j}^{-k} \\
\dfrac{\partial A(z)}{\partial p_{j}} \Bigg|_{z=p_{j}} & = -p_{j}^{-1} \prod\limits_{\substack{k=1 \\ k\ne j}}^{N} (1 - p_{k} p_{j}^{-1}) = -p_{j}^{-N} \prod\limits_{\substack{k=1 \\ k \ne j}}^{N} (p_{j} - p_{k})
\end{align}
$$
从而得到极点位置对系数量化误差的**敏感度**
$$
\dfrac{\partial p_{j}}{\partial a_{k}} = \dfrac{\cfrac{\partial A(z)}{\partial a_{k}} \Bigg|_{z=p_{j}}}{\cfrac{\partial A(z)}{\partial p_{j}} \Bigg|_{z=p_{j}}} = - \dfrac{p_{j}^{N - k}}{\prod\limits_{\substack{l=1 \\ l \ne j}}^{N} (p_{j} - p_{l})}
$$
